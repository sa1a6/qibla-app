<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>اتجاه القبلة - Qibla Direction</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #f3efe0;
      color: #333;
      text-align: center;
      padding: 1em;
      user-select: none;
    }
    #qibla-arrow {
      font-size: 8em;
      margin: 0.2em auto;
      display: inline-block;
      transition: transform 0.5s ease, color 0.5s ease;
      color: #4a90e2;
    }
    #status {
      margin-top: 1em;
      font-size: 1.2em;
      color: #666;
      min-height: 1.5em;
    }
    #angle, #distance {
      font-weight: bold;
      font-size: 1.2em;
      margin-top: 0.5em;
    }
    #retry-btn {
      margin-top: 1em;
      padding: 0.5em 1.5em;
      font-size: 1em;
      cursor: pointer;
      display: none;
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 0.3em;
    }
    #lang-toggle {
      margin-top: 1em;
      cursor: pointer;
      background: #ddd;
      border: none;
      padding: 0.4em 1em;
      border-radius: 0.3em;
      font-weight: bold;
    }
    footer {
      margin-top: 2em;
      font-size: 0.9em;
      color: #aaa;
    }
  </style>
</head>
<body>
  <h1 id="title">اتجاه القبلة</h1>
  <div id="qibla-arrow">🧭</div>
  <div id="angle"></div>
  <div id="distance"></div>
  <div id="status">جاري انتظار إذن الموقع والبوصلة...</div>
  <button id="retry-btn">إعادة المحاولة</button>
  <br />
  <button id="lang-toggle">English</button>

  <footer>حقوق الملكية &copy; صلاح الدين</footer>

  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
  const kaaba = { lat: 21.4225, lon: 39.8262 };
  let userLat = null;
  let userLon = null;
  let qiblaAngle = 0;
  let lastBeepTime = 0;
  const beep = document.getElementById("beep");

  const i18n = {
    ar: {
      angle: "زاوية القبلة: ",
      distance: "المسافة إلى مكة: ",
      locating: "جاري تحديد الموقع...",
      locationError: "تعذر الحصول على الموقع. يرجى السماح بالوصول.",
      compassError: "جهازك لا يدعم بوصلة الاتجاه أو لم يتم تفعيلها.",
      waitingCompass: "تم الحصول على الموقع. جاري انتظار بيانات البوصلة...",
      pointPhone: "يرجى توجيه هاتفك.",
      retry: "إعادة المحاولة",
      langToggle: "English"
    },
    en: {
      angle: "Qibla Angle: ",
      distance: "Distance to Mecca: ",
      locating: "Locating your position...",
      locationError: "Unable to get location. Please allow access.",
      compassError: "Your device does not support compass or it is disabled.",
      waitingCompass: "Location acquired. Waiting for compass data...",
      pointPhone: "Please point your phone.",
      retry: "Retry",
      langToggle: "العربية"
    }
  };

  let currentLang = "ar";

  function setLanguage(lang) {
    currentLang = lang;
    document.getElementById("title").textContent = lang === "ar" ? "اتجاه القبلة" : "Qibla Direction";
    document.getElementById("retry-btn").textContent = i18n[lang].retry;
    document.getElementById("status").textContent = i18n[lang].locating;
    document.getElementById("lang-toggle").textContent = i18n[lang].langToggle;
    document.getElementById("angle").textContent = "";
    document.getElementById("distance").textContent = "";
  }

  function calculateQiblaAngle(lat, lon) {
    const toRadians = (d) => (d * Math.PI) / 180;
    const toDegrees = (r) => (r * 180) / Math.PI;

    const latRad = toRadians(lat);
    const lonRad = toRadians(lon);
    const kaabaLatRad = toRadians(kaaba.lat);
    const kaabaLonRad = toRadians(kaaba.lon);

    const y = Math.sin(kaabaLonRad - lonRad);
    const x = Math.cos(latRad) * Math.tan(kaabaLatRad) - Math.sin(latRad) * Math.cos(kaabaLonRad - lonRad);

    let angle = toDegrees(Math.atan2(y, x));
    if (angle < 0) angle += 360;
    return angle;
  }

  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // km
    const dLat = ((lat2 - lat1) * Math.PI) / 180;
    const dLon = ((lon2 - lon1) * Math.PI) / 180;
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos((lat1 * Math.PI) / 180) *
        Math.cos((lat2 * Math.PI) / 180) *
        Math.sin(dLon / 2) *
        Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return Math.round(R * c);
  }

  function getColorFromDiff(diff) {
    // from red (far) to green (near)
    const ratio = 1 - diff / 180;
    const r = Math.round(255 - (255 - 54) * ratio);
    const g = Math.round(80 - (80 - 54) * ratio);
    const b = 54;
    return `rgb(${r},${g},${b})`;
  }

  function updateQiblaArrow(deviceHeading) {
    const arrow = document.getElementById("qibla-arrow");
    const angleDisplay = document.getElementById("angle");
    const distanceDisplay = document.getElementById("distance");
    let diff = qiblaAngle - deviceHeading;
    if (diff < 0) diff += 360;
    if (diff > 180) diff = 360 - diff;

    arrow.style.transform = `rotate(${qiblaAngle - deviceHeading}deg)`;
    angleDisplay.textContent = i18n[currentLang].angle + Math.round(qiblaAngle) + "°";

    if (userLat !== null && userLon !== null) {
      const dist = calculateDistance(userLat, userLon, kaaba.lat, kaaba.lon);
      distanceDisplay.textContent = i18n[currentLang].distance + dist + " كم";
    }

    arrow.style.color = getColorFromDiff(diff);

    const now = Date.now();
    if (diff <= 5 && now - lastBeepTime > 2000) {
      beep.play().catch(() => {});
      if (navigator.vibrate) navigator.vibrate(300);
      lastBeepTime = now;
    }
  }

  function handleOrientation(event) {
    let heading;
    if (event.webkitCompassHeading !== undefined) {
      heading = event.webkitCompassHeading;
    } else if (event.alpha !== null) {
      heading = 360 - event.alpha;
    } else {
      document.getElementById("status").textContent = i18n[currentLang].compassError;
      window.removeEventListener("deviceorientation", handleOrientation);
      return;
    }
    updateQiblaArrow(heading);
  }

  function startQibla() {
    document.getElementById("retry-btn").style.display = "none";
    document.getElementById("status").textContent = i18n[currentLang].locating;

    if (!navigator.geolocation) {
      document.getElementById("status").textContent = i18n[currentLang].locationError;
      document.getElementById("retry-btn").style.display = "inline-block";
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        qiblaAngle = calculateQiblaAngle(userLat, userLon);
        document.getElementById("status").textContent = i18n[currentLang].waitingCompass;
        window.addEventListener("deviceorientation", handleOrientation, true);
      },
      (err) => {
        document.getElementById("status").textContent = i18n[currentLang].locationError;
        document.getElementById("retry-btn").style.display = "inline-block";
      }
    );
  }

  document.getElementById("retry-btn").addEventListener("click", () => {
    startQibla();
  });

  document.getElementById("lang-toggle").addEventListener("click", () => {
    setLanguage(currentLang === "ar" ? "en" : "ar");
  });

  setLanguage(currentLang);
  startQibla();
</script>
</body>
</html>
