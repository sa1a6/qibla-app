<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>اتجاه القبلة - Qibla Direction</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');

    /* Reset */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #f0f0f0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 2rem 1rem;
      user-select: none;
      text-align: center;
    }

    h1#title {
      font-weight: 700;
      font-size: 2.8rem;
      margin-bottom: 0.5rem;
      text-shadow: 0 0 8px rgba(0,0,0,0.2);
    }

    #qibla-arrow {
      font-size: 11rem;
      margin: 1rem auto 0.5rem auto;
      display: inline-block;
      transition: transform 0.5s ease, color 0.5s ease;
      color: #ffd700;
      filter: drop-shadow(0 0 10px #ffd700);
    }

    #angle, #distance {
      font-weight: 600;
      font-size: 1.3rem;
      margin-top: 0.4rem;
      text-shadow: 0 0 5px rgba(0,0,0,0.15);
    }

    #status {
      margin-top: 1rem;
      font-size: 1.15rem;
      color: #dcdcdccc;
      min-height: 1.7em;
      font-weight: 500;
      text-shadow: 0 0 4px rgba(0,0,0,0.2);
    }

    button, select, input {
      font-family: 'Cairo', sans-serif;
    }

    #retry-btn, #lang-toggle {
      margin-top: 1.3rem;
      padding: 0.65em 2.3em;
      font-size: 1.05rem;
      font-weight: 700;
      border-radius: 40px;
      border: none;
      cursor: pointer;
      background: #ffd700;
      color: #4a2e00;
      box-shadow: 0 4px 8px rgb(255 215 0 / 0.6);
      transition: background-color 0.3s ease, color 0.3s ease;
      user-select: none;
      outline-offset: 2px;
      outline-color: transparent;
      outline-style: solid;
    }

    #retry-btn:hover, #lang-toggle:hover {
      background-color: #fff;
      color: #764ba2;
      box-shadow: 0 6px 12px rgb(255 255 255 / 0.8);
    }

    #manual-location {
      margin-top: 2rem;
      background: rgba(255 255 255 / 0.15);
      padding: 1.8rem 2rem;
      border-radius: 15px;
      width: 320px;
      box-shadow: 0 0 20px rgb(255 255 255 / 0.15);
      user-select: auto;
      backdrop-filter: blur(10px);
    }

    #manual-location label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 700;
      font-size: 1rem;
      color: #ffd700;
      text-shadow: 0 0 4px rgba(0,0,0,0.25);
    }

    #manual-location select, 
    #manual-location input {
      width: 100%;
      padding: 0.55em 0.9em;
      font-size: 1rem;
      border-radius: 10px;
      border: none;
      outline: none;
      box-shadow: inset 0 0 6px rgba(0,0,0,0.15);
      transition: box-shadow 0.3s ease;
      margin-bottom: 1.2rem;
    }

    #manual-location select:focus,
    #manual-location input:focus {
      box-shadow: 0 0 12px #ffd700;
      background: rgba(255 255 255 / 0.3);
      color: #4a2e00;
      font-weight: 700;
    }

    #manual-location button {
      background: #4a2e00;
      color: #ffd700;
      font-weight: 700;
      padding: 0.65em 0;
      font-size: 1.1rem;
      border-radius: 40px;
      border: none;
      width: 100%;
      cursor: pointer;
      box-shadow: 0 4px 10px rgb(74 46 0 / 0.7);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    #manual-location button:hover {
      background: #ffd700;
      color: #4a2e00;
      box-shadow: 0 6px 14px rgb(255 215 0 / 0.8);
    }

    #offline-info {
      margin-top: 1rem;
      color: #ffb347;
      font-weight: 600;
      text-shadow: 0 0 6px rgba(255 179 71, 0.8);
      display: none;
      user-select: none;
    }

    footer {
      margin-top: 3rem;
      font-size: 0.9rem;
      color: #ffd700cc;
      user-select: none;
      text-shadow: 0 0 8px rgba(255, 215, 0, 0.7);
    }

    /* Responsive */
    @media (max-width: 400px) {
      #manual-location {
        width: 90vw;
        padding: 1.4rem 1.5rem;
      }

      #qibla-arrow {
        font-size: 7rem;
      }

      h1#title {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <h1 id="title">اتجاه القبلة</h1>
  <div id="qibla-arrow">🧭</div>
  <div id="angle"></div>
  <div id="distance"></div>
  <div id="status">جاري انتظار إذن الموقع والبوصلة...</div>
  <button id="retry-btn">إعادة المحاولة</button>
  <br />
  <button id="lang-toggle">English</button>

  <div id="manual-location">
    <label for="country">الدولة:</label>
    <select id="country">
      <option value="">اختر الدولة</option>
      <option value="sa">السعودية</option>
      <option value="eg">مصر</option>
      <option value="jo">الأردن</option>
    </select>
    <label for="region">المحافظة / المنطقة:</label>
    <input type="text" id="region" placeholder="أدخل المحافظة أو المنطقة" />
    <button id="manual-location-btn">استخدام الموقع اليدوي</button>
  </div>

  <div id="offline-info">لا تتوفر بيانات الموقع، يرجى توجيه الهاتف إلى اتجاه القبلة باستخدام البوصلة.</div>

  <footer>حقوق الملكية &copy; صلاح الدين</footer>

  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
  const kaaba = { lat: 21.4225, lon: 39.8262 };
  let userLat = null;
  let userLon = null;
  let qiblaAngle = 0;
  let lastBeepTime = 0;
  const beep = document.getElementById("beep");

  const i18n = {
    ar: {
      angle: "زاوية القبلة: ",
      distance: "المسافة إلى مكة: ",
      locating: "جاري تحديد الموقع...",
      locationError: "تعذر الحصول على الموقع. يرجى السماح بالوصول.",
      compassError: "جهازك لا يدعم بوصلة الاتجاه أو لم يتم تفعيلها.",
      waitingCompass: "تم الحصول على الموقع. جاري انتظار بيانات البوصلة...",
      pointPhone: "يرجى توجيه هاتفك.",
      retry: "إعادة المحاولة",
      langToggle: "English",
      manualInputPrompt: "يرجى اختيار الدولة وإدخال المحافظة",
      manualInputError: "لا توجد بيانات لهذه المحافظة. يرجى المحاولة مرة أخرى.",
      offlineMode: "لا تتوفر بيانات الموقع، يرجى توجيه الهاتف."
    },
    en: {
      angle: "Qibla Angle: ",
      distance: "Distance to Mecca: ",
      locating: "Locating your position...",
      locationError: "Unable to get location. Please allow access.",
      compassError: "Your device does not support compass or it is disabled.",
      waitingCompass: "Location acquired. Waiting for compass data...",
      pointPhone: "Please point your phone.",
      retry: "Retry",
      langToggle: "العربية",
      manualInputPrompt: "Please select country and enter region",
      manualInputError: "No data for this region. Please try again.",
      offlineMode: "No location data available, please point your phone."
    }
  };

  let currentLang = "ar";

  function setLanguage(lang) {
    currentLang = lang;
    document.getElementById("title").textContent = lang === "ar" ? "اتجاه القبلة" : "Qibla Direction";
    document.getElementById("retry-btn").textContent = i18n[lang].retry;
    document.getElementById("status").textContent = i18n[lang].locating;
    document.getElementById("lang-toggle").textContent = i18n[lang].langToggle;
    document.getElementById("angle").textContent = "";
    document.getElementById("distance").textContent = "";
    document.getElementById("offline-info").style.display = "none";
  }

  function calculateQiblaAngle(lat, lon) {
    const toRadians = (d) => (d * Math.PI) / 180;
    const toDegrees = (r) => (r * 180) / Math.PI;

    const latRad = toRadians(lat);
    const lonRad = toRadians(lon);
    const kaabaLatRad = toRadians(kaaba.lat);
    const kaabaLonRad = toRadians(kaaba.lon);

    const y = Math.sin(kaabaLonRad - lonRad);
    const x = Math.cos(latRad) * Math.tan(kaabaLatRad) - Math.sin(latRad) * Math.cos(kaabaLonRad - lonRad);

    let angle = toDegrees(Math.atan2(y, x));
    if (angle < 0) angle += 360;
    return angle;
  }

  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // km
    const dLat = ((lat2 - lat1) * Math.PI) / 180;
    const dLon = ((lon2 - lon1) * Math.PI) / 180;
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos((lat1 * Math.PI) / 180) *
        Math.cos((lat2 * Math.PI) / 180) *
        Math.sin(dLon / 2) *
        Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return Math.round(R * c);
  }

  function getColorFromDiff(diff) {
    // from red (far) to yellow (near)
    const ratio = 1 - diff / 180;
    const r = Math.round(255);
    const g = Math.round(215 * ratio + 40);
    const b = 0;
    return `rgb(${r},${g},${b})`;
  }

  function updateQiblaArrow(deviceHeading) {
    const arrow = document.getElementById("qibla-arrow");
    const angleDisplay = document.getElementById("angle");
    const distanceDisplay = document.getElementById("distance");

    if (qiblaAngle === null) {
      arrow.style.color = '#ffb347';
      document.getElementById("status").textContent = i18n[currentLang].offlineMode;
      return;
    }

    let diff = qiblaAngle - deviceHeading;
    if (diff < 0) diff += 360;
    if (diff > 180) diff = 360 - diff;

    arrow.style.transform = `rotate(${qiblaAngle - deviceHeading}deg)`;
    angleDisplay.textContent = i18n[currentLang].angle + Math.round(qiblaAngle) + "°";

    if (userLat !== null && userLon !== null) {
      const dist = calculateDistance(userLat, userLon, kaaba.lat, kaaba.lon);
      distanceDisplay.textContent = i18n[currentLang].distance + dist + " كم";
    } else {
      distanceDisplay.textContent = "";
    }

    arrow.style.color = getColorFromDiff(diff);

    const now = Date.now();
    if (diff <= 5 && now - lastBeepTime > 2000) {
      beep.play().catch(() => {});
      if (navigator.vibrate) navigator.vibrate(300);
      lastBeepTime = now;
    }
  }

  function handleOrientation(event) {
    let heading;
    if (event.webkitCompassHeading !== undefined) {
      heading = event.webkitCompassHeading;
    } else if (event.alpha !== null) {
      heading = 360 - event.alpha;
    } else {
      document.getElementById("status").textContent = i18n[currentLang].compassError;
      window.removeEventListener("deviceorientation", handleOrientation);
      return;
    }
    updateQiblaArrow(heading);
  }

  function startCompass() {
    if (
      typeof DeviceOrientationEvent !== "undefined" &&
      typeof DeviceOrientationEvent.requestPermission === "function"
    ) {
      DeviceOrientationEvent.requestPermission()
        .then((response) => {
          if (response === "granted") {
            window.addEventListener("deviceorientation", handleOrientation, true);
            document.getElementById("status").textContent = i18n[currentLang].pointPhone;
          } else {
            document.getElementById("status").textContent = i18n[currentLang].compassError;
          }
        })
        .catch(() => {
          document.getElementById("status").textContent = i18n[currentLang].compassError;
        });
    } else {
      window.addEventListener("deviceorientation", handleOrientation, true);
      document.getElementById("status").textContent = i18n[currentLang].pointPhone;
    }
  }

  function offlineMode() {
    document.getElementById("status").textContent = i18n[currentLang].offlineMode;
    document.getElementById("offline-info").style.display = "block";
    startCompass();
  }

  function startQibla() {
    document.getElementById("retry-btn").style.display = "none";
    document.getElementById("status").textContent = i18n[currentLang].locating;

    if (!navigator.geolocation) {
      document.getElementById("status").textContent = i18n[currentLang].locationError;
      document.getElementById("retry-btn").style.display = "inline-block";
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        localStorage.setItem("lastKnownLat", userLat);
        localStorage.setItem("lastKnownLon", userLon);
        qiblaAngle = calculateQiblaAngle(userLat, userLon);
        document.getElementById("status").textContent = i18n[currentLang].waitingCompass;
        startCompass();
      },
      (err) => {
        const savedLat = localStorage.getItem("lastKnownLat");
        const savedLon = localStorage.getItem("lastKnownLon");
        if (savedLat && savedLon) {
          userLat = parseFloat(savedLat);
          userLon = parseFloat(savedLon);
          qiblaAngle = calculateQiblaAngle(userLat, userLon);
          document.getElementById("status").textContent =
            currentLang === "ar"
              ? "لم نستطع الحصول على الموقع الحالي، نستخدم الموقع المخزن سابقًا."
              : "Unable to get current location, using last known location.";
          startCompass();
        } else {
          offlineMode();
        }
      },
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
  }

  // بيانات تقريبية للمحافظات
 const locations = {
  sa: {
    الرياض: { lat: 24.7136, lon: 46.6753 },
    جدة: { lat: 21.4858, lon: 39.1925 },
    مكة: { lat: 21.3891, lon: 39.8579 },
    الدمام: { lat: 26.3927, lon: 49.9777 },
    المدينة: { lat: 24.5247, lon: 39.5692 },
    الطائف: { lat: 21.2703, lon: 40.4158 },
    خميس مشيط: { lat: 18.3068, lon: 42.7290 },
    بريدة: { lat: 26.3260, lon: 43.9743 },
    حائل: { lat: 27.5114, lon: 41.7208 },
    تبوك: { lat: 28.3838, lon: 36.5559 },
    جيزان: { lat: 16.8892, lon: 42.5519 },
    نجران: { lat: 17.4871, lon: 44.1261 },
    أبها: { lat: 18.2184, lon: 42.5053 }
  },
  eg: {
    القاهرة: { lat: 30.0444, lon: 31.2357 },
    الإسكندرية: { lat: 31.2001, lon: 29.9187 },
    الجيزة: { lat: 30.0131, lon: 31.2089 },
    الشرقية: { lat: 30.5833, lon: 31.5000 },
    الدقهلية: { lat: 31.0553, lon: 31.3785 },
    البحيرة: { lat: 30.8667, lon: 30.9167 },
    المنوفية: { lat: 30.5500, lon: 30.9333 },
    القليوبية: { lat: 30.2915, lon: 31.2445 },
    سوهاج: { lat: 26.5603, lon: 31.6956 },
    أسيوط: { lat: 27.1859, lon: 31.1839 }
  },
  jo: {
    عمان: { lat: 31.9454, lon: 35.9284 },
    إربد: { lat: 32.5569, lon: 35.8513 },
    الزرقاء: { lat: 32.0723, lon: 36.0888 },
    العقبة: { lat: 29.5328, lon: 35.0062 },
    المفرق: { lat: 32.3500, lon: 36.2167 },
    الكرك: { lat: 31.1810, lon: 35.7044 },
    الطفيلة: { lat: 30.7890, lon: 35.5790 }
  }


  };

  document.getElementById("manual-location-btn").addEventListener("click", () => {
    const country = document.getElementById("country").value;
    const region = document.getElementById("region").value.trim();

    if (!country || !region) {
      alert(i18n[currentLang].manualInputPrompt);
      return;
    }

    if (locations[country] && locations[country][region]) {
      userLat = locations[country][region].lat;
      userLon = locations[country][region].lon;
      qiblaAngle = calculateQiblaAngle(userLat, userLon);
      document.getElementById("status").textContent = i18n[currentLang].waitingCompass;
      document.getElementById("offline-info").style.display = "none";
      startCompass();
    } else {
      alert(i18n[currentLang].manualInputError);
    }
  });

  document.getElementById("retry-btn").addEventListener("click", () => {
    startQibla();
  });

  document.getElementById("lang-toggle").addEventListener("click", () => {
    setLanguage(currentLang === "ar" ? "en" : "ar");
  });

  setLanguage(currentLang);
  startQibla();
</script>
</body>
</html>
